# Архитектура командной оболочки

## Главный цикл

![](/images/main_loop.png)

Программа представляет собой цикл из 4 этапов:
1. *Ввод строки* -- получение строки от пользователя;
2. *Подстановка значений переменных* -- преобразование строки;
3. *Парсинг строки* -- получение программы на исполнение или синтаксической ошибки;
4. *Выполнение команд* -- получение флага, нужно ли завершить работу оболочки или нет.

Более подробно о каждом из этапов см. ниже.

Также существует отдельный "модуль" для хранения значений переменных окружения, к которому этап *Подстановка значений переменных*
имеет доступ на чтение, а этап *Выполнение команд* -- на чтение и запись.

## Ввод строки

Состоит из 2 шагов:
1. *Вывод приветствия* (в нашем случае строки "$ ")
2. *Чтение пользовательской программы*, оканчивающейся знаком перевода строки

## Подстановка значений переменных

![](/images/substitutor.png)

Обработка строки, полученной на предыдущем этапе, выполняется с помощью *модифицированного* конечного автомата. А именно кроме
посимвольного чтения входной строки и переходу по символам в состояния будем также хранить буфер результата `R` и буфер имени
переменной `N`.

Нотация следующая:
* Чёрная стрелка -- запись прочитанного символа в `R`;
* Оранжевая стрелка -- nop;
* Зелёная стрелка -- запись прочитанного символа в `N`;
* Если предыдущий переход был сделан не по чёрной стрелке, а текущий -- по чёрной (или мы достигли конца строки), то записываем
в `R` строку из переменной с именем из `N` с последующим очищением `N`;
* ЛСИП -- латинский символ или подчёркивание;
* Стрелка без подписи означает переход по любому символу.

## Парсинг строки

TODO

## Выполнение команд

![](/images/hierarchy_of_primitives.png)

Выполнение *примитива* происходит следующим образом:
1. при присваивании обновляем хранилище переменных
2. при одной команде исполняем её (о том как -- позже)
3. при нескольких командах через pipe проверяем, что среди команд нет специальных
4. если есть специальные команды, то выводим семантическую ошибку
5. если специальных команд нет, то исполняем команды с перенаправлением ввода/вывода

Выполнение *команды* происходит следующим образом:
1. специальная команда влияет на работу оболочки (в частности `exit` завершает работу)
2. внутренняя исполняется самой оболочкой (в частности `echo` пишет в вывод свои аргументы)
3. внешняя ищется в директориях из `PATH`
4. если не нашлась, то выводим ошибку о том, что команда не найдена
5. если нашлась, то запускаем с соответствующими аргументами
